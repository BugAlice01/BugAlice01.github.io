
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>bluecms审计复现 | Alice01</title>
    <meta name="author" content="Alice01" />
    <meta name="description" content="" />
    <meta name="keywords" content="" />
    <meta
        name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"
    />
    <link rel="icon" href="/images/tx.jpg" />
    <link rel="preconnect" href="https://s4.zstatic.net" />
<script src="https://s4.zstatic.net/ajax/libs/vue/3.3.7/vue.global.prod.min.js"></script>
<link rel="stylesheet" href="https://s4.zstatic.net/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
<link rel="preconnect" href="https://fonts.googleapis.cn" />
<link rel="preconnect" href="https://fonts.gstatic.cn" crossorigin />
<link
    rel="stylesheet"
    href="https://fonts.googleapis.cn/css2?family=Fira+Code:wght@400;500;600;700&family=Lexend:wght@400;500;600;700;800;900&family=Noto+Sans+SC:wght@400;500;600;700;800;900&display=swap"
/>
<script> const mixins = {}; </script>

<script src="https://polyfill.alicdn.com/v3/polyfill.min.js?features=default"></script>


<script src="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://s4.zstatic.net/ajax/libs/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js"></script>
<link
    rel="stylesheet"
    href="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/styles/github.min.css"
/>
<script src="/js/lib/highlight.js"></script>



<script src="/js/lib/preview.js"></script>









<link rel="stylesheet" href="/css/main.css" />

<meta name="generator" content="Hexo 7.3.0"></head>
<body>
    <div id="layout">
        <transition name="fade">
            <div id="loading" v-show="loading">
                <div id="loading-circle">
                    <h2>LOADING</h2>
                    <p>加载过慢请开启缓存 浏览器默认开启</p>
                    <img src="/images/loading.gif" />
                </div>
            </div>
        </transition>
        <div id="menu" :class="{ hidden: hiddenMenu, 'menu-color': menuColor}">
    <nav id="desktop-menu">
        <a class="title" href="/">
            <span>ALICE01</span>
        </a>
        
        <a href="/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;Home</span>
        </a>
        
        <a href="/archives">
            <i class="fa-solid fa-box-archive fa-fw"></i>
            <span>&ensp;Archives</span>
        </a>
        
    </nav>
    <nav id="mobile-menu">
        <div class="title" @click="showMenuItems = !showMenuItems">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;ALICE01</span>
        </div>
        <transition name="slide">
            <div class="items" v-show="showMenuItems">
                
                <a href="/">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-house fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Home</div>
                    </div>
                </a>
                
                <a href="/archives">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-box-archive fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Archives</div>
                    </div>
                </a>
                
            </div>
        </transition>
    </nav>
</div>
<transition name="fade">
    <div id="menu-curtain" @click="showMenuItems = !showMenuItems" v-show="showMenuItems"></div>
</transition>

        <div id="main" :class="loading ? 'into-enter-from': 'into-enter-active'">
            <div class="article">
    <div>
        <h1>bluecms审计复现</h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2025/8/11
        </span>
        
        
        <span class="tags">
            <span class="icon">
                <i class="fa-solid fa-tags fa-fw"></i>
            </span>
            
            
            <span class="tag">
                
                <a href="/tags/%E5%AE%A1%E8%AE%A1/" style="color: #00bcd4">
                    审计
                </a>
            </span>
            
        </span>
        
    </div>
    
    <div class="content" v-pre>
        <h2 id="1-ad-js-php-ad-id存在sql注入因为拼接无单引号，可以绕过魔术引号转译"><a href="#1-ad-js-php-ad-id存在sql注入因为拼接无单引号，可以绕过魔术引号转译" class="headerlink" title="1.ad_js.php(ad_id存在sql注入因为拼接无单引号，可以绕过魔术引号转译)"></a>1.ad_js.php(ad_id存在sql注入因为拼接无单引号，可以绕过魔术引号转译)</h2><h4 id="声明"><a href="#声明" class="headerlink" title="声明"></a>声明</h4><blockquote>
<p>$ad_id &#x3D; !empty($_GET[‘ad_id’]) ? trim($_GET[‘ad_id’]) : ‘’;</p>
</blockquote>
<h4 id="语句"><a href="#语句" class="headerlink" title="语句"></a>语句</h4><blockquote>
<p>$ad &#x3D; $db-&gt;getone(“SELECT * FROM “.table(‘ad’).” WHERE ad_id &#x3D;<strong>“.$ad_id</strong>);</p>
</blockquote>
<h2 id="2-article-php-act-del时，id存在sql注入因为第一次未过滤"><a href="#2-article-php-act-del时，id存在sql注入因为第一次未过滤" class="headerlink" title="2.article.php(act&#x3D;del时，id存在sql注入因为第一次未过滤)"></a>2.article.php(act&#x3D;del时，id存在sql注入因为第一次未过滤)</h2><span id="more"></span>

<blockquote>
<p>elseif($act &#x3D;&#x3D; ‘del’){<br>    $article &#x3D; $db-&gt;getone(“SELECT cid, lit_pic FROM “.table(‘article’).” WHERE id&#x3D;”<strong>.$_GET[‘id’])</strong>;<br>     $sql &#x3D; “DELETE FROM “.table(‘article’).” WHERE id&#x3D;”.intval($_GET[‘id’]);<br>     $db-&gt;query($sql);<br>     if (file_exists(BLUE_ROOT.$article[‘lit_pic’])) {<br>         @unlink(BLUE_ROOT.$article[‘list_pic’]);<br>     }</p>
</blockquote>
<h2 id="3-common-fun-php-多处存在sql注入"><a href="#3-common-fun-php-多处存在sql注入" class="headerlink" title="3.common.fun.php(多处存在sql注入)"></a>3.common.fun.php(多处存在sql注入)</h2><h4 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h4><blockquote>
<p>getenv(搜索 name 所指向的环境字符串，并返回相关的值给字符串)</p>
</blockquote>
<h4 id="语句-1"><a href="#语句-1" class="headerlink" title="语句"></a>语句</h4><blockquote>
<p>function getip()<br>{<br>    if (getenv(‘HTTP_CLIENT_IP’))<br>    {<br>        $ip &#x3D; <strong>getenv</strong>(‘HTTP_CLIENT_IP’);<br>    }<br>    elseif (getenv(‘HTTP_X_FORWARDED_FOR’))<br>    { &#x2F;&#x2F;????????????????????????????ip ???<br>        $ip &#x3D; <strong>getenv</strong>(‘HTTP_X_FORWARDED_FOR’);<br>    }<br>    elseif (getenv(‘HTTP_X_FORWARDED’))<br>    {<br>        $ip &#x3D; <strong>getenv</strong>(‘HTTP_X_FORWARDED’);<br>    }<br>    elseif (getenv(‘HTTP_FORWARDED_FOR’))<br>    {<br>        $ip &#x3D; <strong>getenv</strong>(‘HTTP_FORWARDED_FOR’);<br>    }<br>    elseif (<strong>getenv</strong>(‘HTTP_FORWARDED’))<br>    {<br>        $ip &#x3D; <strong>getenv</strong>(‘HTTP_FORWARDED’);<br>    }<br>    else<br>    {<br>        $ip &#x3D; $_SERVER[‘REMOTE_ADDR’];<br>    }<br>    return $ip;<br>}</p>
</blockquote>
<h2 id="4-admin-tpl-manage-php-tpl-name存在任意文件读取-修改"><a href="#4-admin-tpl-manage-php-tpl-name存在任意文件读取-修改" class="headerlink" title="4.admin&#x2F;tpl_manage.php(tpl_name存在任意文件读取&#x2F;修改)"></a>4.admin&#x2F;tpl_manage.php(tpl_name存在任意文件读取&#x2F;修改)</h2><h4 id="语句-2"><a href="#语句-2" class="headerlink" title="语句"></a>语句</h4><blockquote>
<p>elseif($act &#x3D;&#x3D; ‘edit’){<br><strong>$file &#x3D; $_GET[‘tpl_name’];</strong><br>if(!$handle &#x3D; @fopen(BLUE_ROOT.’templates&#x2F;default&#x2F;‘<strong>.$file</strong>, ‘rb’)){<br>    showmsg(‘打开目标模板文件失败’);<br>}<br>$tpl[‘content’] &#x3D; fread($handle, filesize(BLUE_ROOT.’templates&#x2F;default&#x2F;‘.$file));<br>$tpl[‘content’] &#x3D; htmlentities($tpl[‘content’], ENT_QUOTES, GB2312);<br>fclose($handle);<br>$tpl[‘name’] &#x3D; $file;<br>template_assign(array(‘current_act’, ‘tpl’), array(‘编辑模板’, $tpl));<br>$smarty-&gt;display(‘tpl_info.htm’);<br>}<br>elseif($act &#x3D;&#x3D; ‘do_edit’){<br>    $tpl_name &#x3D; !empty($_POST[‘tpl_name’]) ? trim($_POST[‘tpl_name’]) : ‘’;<br>    $tpl_content &#x3D; !empty($_POST[‘tpl_content’]) ? deep_stripslashes($_POST[‘tpl_content’]) : ‘’;<br>    if(empty($tpl_name)){<br>        return false;<br>    }<br>    $tpl &#x3D; BLUE_ROOT.’templates&#x2F;default&#x2F;‘<strong>.$tpl_name</strong>;<br>    if(!$handle &#x3D; @fopen($tpl, ‘wb’)){<br>    showmsg(“打开目标模版文件 $tpl 失败”);<br>    }<br>    if(fwrite($handle, $tpl_content) &#x3D;&#x3D;&#x3D; false){<br>        showmsg(‘写入目标 $tpl 失败’);<br>    }<br>    fclose($handle);<br>    showmsg(‘编辑模板成功’, ‘tpl_manage.php’);<br>}</p>
</blockquote>
<h2 id="5-user-php-act-pay，pay存在文件包含-act-do-login，from存在文件包含"><a href="#5-user-php-act-pay，pay存在文件包含-act-do-login，from存在文件包含" class="headerlink" title="5.user.php(act&#x3D;pay，pay存在文件包含;act&#x3D;do_login，from存在文件包含)"></a>5.user.php(act&#x3D;pay，pay存在文件包含;act&#x3D;do_login，from存在文件包含)</h2><h4 id="语句-3"><a href="#语句-3" class="headerlink" title="语句"></a>语句</h4><blockquote>
<p>elseif ($act &#x3D;&#x3D; ‘pay’){<br>     include ‘data&#x2F;pay.cache.php’;<br>     $price &#x3D; $_POST[‘price’];<br>     $id &#x3D; $_POST[‘id’];<br>     $name &#x3D; $_POST[‘name’];<br>     if (empty($_POST[‘pay’])) {<br>         showmsg(‘�Բ�����û��ѡ��֧����ʽ’);<br>     }<br>     include ‘include&#x2F;payment&#x2F;‘<strong>.$_POST[‘pay’].</strong>“&#x2F;index.php”;<br> }</p>
<p>elseif($act &#x3D;&#x3D; ‘do_login’){<br>    $user_name  	&#x3D; 	!empty($_POST[‘user_name’]) ? trim($_POST[‘user_name’]) : ‘’;<br>    $pwd 			&#x3D; 	!empty($_POST[‘pwd’]) ? trim($_POST[‘pwd’]) : ‘’;<br>    $safecode   	&#x3D; 	!empty($_POST[‘safecode’]) ? trim($_POST[‘safecode’]) : ‘’;<br>    $useful_time	&#x3D;	intval($_POST[‘useful_time’]);<br>    $from &#x3D; !empty($from) ? base64_decode($from) : ‘user.php’;</p>
</blockquote>
<h2 id="6-user-php-email、msn等变量存在xss因为trim只过滤头尾空格"><a href="#6-user-php-email、msn等变量存在xss因为trim只过滤头尾空格" class="headerlink" title="6.user.php(email、msn等变量存在xss因为trim只过滤头尾空格)"></a>6.user.php(email、msn等变量存在xss因为trim只过滤头尾空格)</h2><h4 id="函数-1"><a href="#函数-1" class="headerlink" title="函数"></a>函数</h4><blockquote>
<p>htmlspecialchars()[将特殊字符转换为 HTML 实体]</p>
</blockquote>
<blockquote>
<p>trim()[去除头尾空格]</p>
</blockquote>
<blockquote>
<p>mb_substr(“字符串”, 开始位, 结束位)[按开始-结束取字符串]</p>
</blockquote>
<blockquote>
<p>function filter_data($str)[<strong>img src onerror或大小写或重写绕过xss</strong>]<br>{<br>$str &#x3D; preg_replace(“&#x2F;&lt;(/?)(script|i?frame|meta|link)(\s*)[^&lt;]*&gt;&#x2F;“, “”, $str);<br>return $str;<br>}</p>
</blockquote>
<h4 id="语句-4"><a href="#语句-4" class="headerlink" title="语句"></a>语句</h4><blockquote>
<p>elseif($act &#x3D;&#x3D; ‘edit_user_info’){<br>     $user_id &#x3D; intval($_SESSION[‘user_id’]);<br>     if(empty($user_id)){<br>         return false;<br>     }<br>    $birthday &#x3D; <strong>trim(</strong>$_POST[‘birthday’]);<br>    $sex &#x3D; intval($_POST[‘sex’]);<br>    $email &#x3D; !empty($_POST[‘email’]) ? <strong>trim(</strong>$_POST[‘email’]) : ‘’;<br>    $msn &#x3D; !empty($_POST[‘msn’]) ? <strong>trim(</strong>$_POST[‘msn’]) : ‘’;<br>    $qq &#x3D; !empty($_POST[‘qq’]) ? <strong>trim(</strong>$_POST[‘qq’]) : ‘’;<br>    $mobile_phone &#x3D; !empty($_POST[‘mobile_phone’]) ? <strong>trim(</strong>$_POST[‘mobile_phone’]) : ‘’;<br>    $office_phone &#x3D; !empty($_POST[‘office_phone’]) ? <strong>trim(</strong>$_POST[‘office_phone’]) : ‘’;<br>    $home_phone   &#x3D; !empty($_POST[‘home_phone’]) ? <strong>trim(</strong>$_POST[‘home_phone’]) : ‘’;<br>    $address &#x3D; !empty($_POST[‘address’]) ? htmlspecialchars($_POST[‘address’]) : ‘’;</p>
</blockquote>
<blockquote>
<p>$content &#x3D; !empty($_POST[‘content’]) ? <strong>filter_data(</strong>$_POST[‘content’]) : ‘’;<br>$descript &#x3D; !empty($_POST[‘descript’]) ? <strong>mb_substr(</strong>$_POST[‘descript’], 0, 90) : mb_substr(html2text($_POST[‘content’]),0, 90);</p>
</blockquote>
<h2 id="7-admin-login-php-宽字节注入-数据库编码为gbk，且用preg-replace-把单引号转换成-或自带函数addslashes-进行转义，易发生宽字节注入"><a href="#7-admin-login-php-宽字节注入-数据库编码为gbk，且用preg-replace-把单引号转换成-或自带函数addslashes-进行转义，易发生宽字节注入" class="headerlink" title="7.&#x2F;admin&#x2F;login.php(宽字节注入[数据库编码为gbk，且用preg_replace()把单引号转换成&#39;或自带函数addslashes()进行转义，易发生宽字节注入])"></a>7.&#x2F;admin&#x2F;login.php(宽字节注入[数据库编码为gbk，且用preg_replace()把单引号转换成&#39;或自带函数addslashes()进行转义，易发生宽字节注入])</h2><h4 id="数据处理"><a href="#数据处理" class="headerlink" title="数据处理"></a>数据处理</h4><blockquote>
<p>require_once(dirname(__FILE__ ) . ‘&#x2F;include&#x2F;common.inc.php’);</p>
</blockquote>
<blockquote>
<p><strong>&#x2F;include&#x2F;common.inc.php中二次包含mysql,class.php,跟进</strong><br>require_once(BLUE_ROOT.’include&#x2F;mysql.class.php’);<br><strong>mysql.class.php</strong>[数据库为gbk]</p>
</blockquote>
<blockquote>
<p>function mysql($dbhost, $dbuser, $dbpw, $dbname &#x3D; ‘’, $dbcharset &#x3D; ‘<strong>gbk</strong>‘, $connect&#x3D;1){<br>$func &#x3D; empty($connect) ? ‘mysql_pconnect’ : ‘mysql_connect’;<br>if(!$this-&gt;linkid &#x3D; @$func($dbhost, $dbuser, $dbpw, true)){<br>    $this-&gt;dbshow(‘Can not connect to Mysql!’);<br>} else {<br>    if($this-&gt;dbversion() &gt; ‘4.1’){<br>        mysql_query( “SET NAMES <strong>gbk</strong>“);<br>        if($this-&gt;dbversion() &gt; ‘5.0.1’){<br>            mysql_query(“SET sql_mode &#x3D; ‘’”,$this-&gt;linkid);<br>        }</p>
</blockquote>
<h4 id="语句-5"><a href="#语句-5" class="headerlink" title="语句"></a>语句</h4><blockquote>
<p>require_once(dirname(__FILE__) . ‘<strong>&#x2F;include&#x2F;common.inc.php</strong>‘);<br>$act &#x3D; !empty($_REQUEST[‘act’]) ? trim($_REQUEST[‘act’]) : ‘login’;<br>if($act &#x3D;&#x3D; ‘login’){<br>    if($_SESSION[‘admin_id’]){<br>        showmsg(‘您已登录，不用再次登录’, ‘index.php’);<br>    }<br>    template_assign(‘current_act’, ‘登录’);<br>    $smarty-&gt;display(‘login.htm’);<br>}<br>elseif($act &#x3D;&#x3D; ‘do_login’){<br>    $admin_name &#x3D; isset($_POST[‘admin_name’]) ? trim($_POST[‘admin_name’]) : ‘’;<br>    $admin_pwd &#x3D; isset($_POST[‘admin_pwd’]) ? trim($_POST[‘admin_pwd’]) : ‘’;<br>    $remember &#x3D; isset($_POST) ? intval($_POST[‘rememberme’]) : 0;</p>
</blockquote>

    </div>
    
    
    
    
    
    
    
</div>

            <footer id="footer">
    <div id="footer-wrap">
        <div>
            &copy;
            2024 - 2025 Alice01
            <span id="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            &commat;Alice01
        </div>
        <div>
            Based on the <a target="_blank" rel="noopener" href="https://hexo.io">Hexo Engine</a> &amp;
            <a target="_blank" rel="noopener" href="https://github.com/theme-particlex/hexo-theme-particlex">ParticleX Theme</a>
        </div>
        
    </div>
</footer>

        </div>
        
        <transition name="fade">
            <div id="preview" ref="preview" v-show="previewShow">
                <img id="preview-content" ref="previewContent" />
            </div>
        </transition>
        
    </div>
    <script src="/js/main.js"></script>
    
    




    
</body>
</html>
